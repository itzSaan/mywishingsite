/*!
* myMandir.js
*/

// MyMandir Class
(function(window) {
  "use strict";

  function instance() {
    var MyMandir = {};

    MyMandir.isAndroid = function() {
      var ua = navigator.userAgent.toLowerCase();
      var isAndroid = ua.indexOf("android") > -1;
      return isAndroid;
    };

    MyMandir.isMiniApp = function() {
      return typeof mymandirApp !== "undefined";
    };

    MyMandir.isFBSDKAvailable = function() {
      return typeof FB !== "undefined";
    };

    MyMandir.shareWhatsapp = function(shareString) {
      if (MyMandir.isMiniApp()) {
        mymandirApp.shareOnWhatsApp(shareString);
      } else {
        var whatsappHref = "whatsapp://send?text=" + shareString;
        window.location.href = whatsappHref;
      }
    };

    MyMandir.shareFacebook = function(shareString) {
      if (MyMandir.isMiniApp()) {
        mymandirApp.shareOnFacebook(shareString);
      } else if (MyMandir.isFBSDKAvailable()) {
        // This works only in web browsers
        FB.ui(
          {
            method: "share",
            href: shareString
          },
          function(response) {
            console.log("Shared on facebook!");
          }
        );
      } else {
        FB.ui(
          {
            method: "share",
            href: shareString
          },
          function(response) {
            console.log("Shared on facebook!");
          }
        );
      }
    };

    MyMandir.showToastMessage = function(message, longDuration) {
      if (MyMandir.isMiniApp()) {
        mymandirApp.makeToast(message, longDuration);
      } else {
        alert(message);
      }
    };

    MyMandir.openExternal = function(url) {
      if (MyMandir.isMiniApp()) {
        mymandirApp.openExternalLink(url);
      } else {
        window.location.href = url;
      }
    };

    MyMandir.openAppScheme = function(appURIScheme, appEventName) {
      if (MyMandir.isMiniApp()) {
        mymandirApp.openURISchemeWithEvent(appURIScheme, appEventName);
      }
      return;
    };

    return MyMandir;
  }

  if (typeof MyMandir === "undefined") {
    window.MyMandir = instance();
  }
})(window);

var jqs = function(sParam) {
  var sPageURL = window.location.search.substring(1);
  var sURLVariables = sPageURL.split("&");
  for (var i = 0; i < sURLVariables.length; i++) {
    var sParameterName = sURLVariables[i].split("=");
    if (sParameterName[0] === sParam) {
      return sParameterName[1];
    }
  }
};

window.jqs = jqs;

var name = decodeURI(jqs("name"));
console.log("NAME:", name);

if (typeof jqs("name") === "undefined") {
  name = "";
}

var showNotification = function() {
clevertap.notifications.push({
  "titleText":'Would you like to receive Push Notifications?',
  "bodyText":'We promise to only send you relevant content and give you updates on your transactions',
  "okButtonText":'Sign me up!',
  "rejectButtonText":'No thanks',
  "skipDialog":true,
  "okButtonColor":'#f28046'});
};

var toggleModuleAfterCreation = function() {
  document.querySelector(".create-module").style.display = "none";
  document.querySelector(".share-module").style.display = "flex";
};

var checkName = function() {
  if (name.length !== 0) {
    name = name.replace(/-/g, " ");
    console.log("name is there", name);
    document.querySelector("#show-name").innerHTML = name;
  document.querySelector(".wishes").style.display = "flex";
  } else {
    console.log("name NOT there");
    document.querySelector(".wishes").style.display = "none";
  }
};

checkName();

// if (typeof mymandirApp !== "undefined") {
//   var userid = mymandirApp.getUserId();
//   fetch("https://api.mymandir.com/user/get?user=" + userid)
//     .then(function(blob) {
//       return blob.json();
//     })
//     .then(function(resp) {
//       console.log("RESP", resp.name);
//       if (resp.status === "verified") {
//         name = '';
//       }
//     })
//     .then(checkName);
// }

var formModal = document.getElementById("form-modal");

function formModalToggler() {
  formModal.classList.toggle("open");
}
document.querySelector(".show-form-btn").addEventListener('click', function() {
  formModalToggler();
  ga('send', {
    hitType: 'event',
    eventCategory: 'Greeting',
    eventAction: 'StartGreeting',
    eventLabel: window.location.href
  });
});

document.querySelector(".close-form-btn").addEventListener('click', function() {
  formModalToggler();
});

function checkValidation() {
  name = document.querySelector("#name-input").value;
  if(name.length===0){
    alert("ନିଜ ନାଁ ଲେଖନ୍ତୁ");
    return false;
  }
  return true;

}

function displayName() {
  name = document.querySelector("#name-input").value;
  document.querySelector("#show-name").innerHTML = name;
  document.querySelector("#name-input").value = "";
  document.querySelector(".wishes").style.display = "flex";
  document.querySelector(".views").scrollTop = 0;
}

document.getElementById('name-input').onkeydown = function() {
  document.querySelector('#tick1').style.display = "block"
};

function formSubmit() {
  console.log("trying to submit");
  if(!checkValidation()){
    return;
  }
  toggleModuleAfterCreation();
  document.querySelector("#my-form").style.display = "none"
  document.querySelector(".loader-cntnr").style.display = "flex"
  setTimeout(
    function() {
      document.querySelector(".loader-cntnr").style.display = "none"
      document.querySelector(".in-form-share-cntnr").style.display = "flex"
      displayName();
    }, 2000);


  ga('send', {
    hitType: 'event',
    eventCategory: 'Greeting',
    eventAction: 'CreateGreeting',
    eventLabel: window.location.href
  });
};

// if(shareUrl.length === 0) {
//   alert("Missing share url!")
//   throw new Error("Missing share url");
// }

var shareMsg = function(n) {
  return "#name# ଆପଣଙ୍କୁ ପବିତ୍ର ଗଣେଶ ଚତୁର୍ଥୀର ଅଭିନନ୍ଦନ ଜଣାଉଛନ୍ତି%0Aମୋ ତରଫରୁ ଏହି ବିଶେଷ ମେସେଜ କୁ ଦେଖନ୍ତୁ।%0A".replace(/#name#/gi, n);
};

var shareActionWA = function() {
  var shareString = "";
  var whatsappHref;
  shareString += shareMsg(name);
  shareString +=
    (window.location.href.split("?")[0] + "?name=" + name)
      .replace("#", "")
      .replace(/ /g, "-")
      + shareUrl;
  if (typeof mymandirApp !== "undefined") {
    console.log("shareString", shareString.replace(/%0A/g, "\n"));
    mymandirApp.shareOnWhatsApp(shareString.replace(/%0A/g, "\n"));
  } else if (MyMandir.isAndroid()) {
    console.log("shareString", shareString);
    whatsappHref = "whatsapp://send?text=" + shareString;
    console.log("whatsAppref", whatsappHref);
    window.location.href = whatsappHref;
  } else {
    console.log("shareString", shareString);
    whatsappHref = "whatsapp://send?text=" + shareString;
    console.log("whatsAppref", whatsappHref);
    window.location.href = whatsappHref;
  }
  showNotification();
  ga('send', {
    hitType: 'event',
    eventCategory: 'Greeting',
    eventAction: 'ShareGreetingWA',
    eventLabel: window.location.href
  });
};

var shareActionFB = function() {
  name = name.replace(/ /g, "-");
  var shareString = (
    window.location.href.split("?")[0] +
    "?name=" +
    name
  ).replace("#", "");
  console.log(shareString);
  if (MyMandir.isAndroid()) {
    FB.ui(
      {
        method: "share",
        href: shareString
      },
      function(response) {
        console.log("Shared on facebook!");
      }
    );
  } else {
    FB.ui(
      {
        method: "share",
        href: shareString
      },
      function(response) {
        console.log("Shared on facebook!");
      }
    );
  }
  showNotification();
  ga('send', {
    hitType: 'event',
    eventCategory: 'Greeting',
    eventAction: 'ShareGreetingFB',
    eventLabel: window.location.href
  });
};
